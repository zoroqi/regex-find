---
version: 0.0.9
---

# 2025-12-18

## 目標

- [ ] 提供一個常見正則的幫助文檔
- [ ] 實現一個歷史記錄配置文件

## 需求

### 正則表達式幫助文檔

為用戶提供一個快速參考, 方便查找和使用常見的正則表達式模式, 降低使用門檻.

功能設計:
-   **觸發方式**: 在應用程序中, 按下 `F2` 鍵可切換顯示幫助文檔視圖.
-   **視圖**:
    -   一個新的彈出式窗口或者一個分割的面板, 覆蓋在主界面之上.
    -   該視圖將顯示一個可滾動的列表, 其中包含常見正則表達式的標題和模式.
    -   用戶可以從列表中選擇一個模式, 該模式將被自動填充到應用的正則表達式輸入框中.
-   **內容存儲**:
    -   幫助文檔的內容將存儲在一個獨立的 `internal/app/regex_help.go` 文件中.
    -   使用一個 `struct` 數組來存儲幫助信息, 每個 `struct` 包含 `Title` 和 `Pattern` 字段.
    -   這樣做便於未來擴展和維護, 無需讀取外部文件.
-   正則幫助文檔需要包含"常用正則"和"基本正則轉義符"兩部分內容.

示例內容:
-   Email: `(?i)^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$`
-   IPv4 地址: `\b(?:\d{1,3}\.){3}\d{1,3}\b`
-   URL: `https://?[\w\d/.-]+`
-   日期 (YYYY-MM-DD): `\d{4}-\d{2}-\d{2}`
-   匹配數字: `\d`
-   匹配單詞: `\w`

設計方案:
1.  **`internal/app/ui.go`**:
    -   修改 `update` 函數, 增加對 `tea.KeyMsg` 的處理, 監聽 `F2` 鍵事件.
    -   當 `F2` 被觸發時, 切換一個 `model` 中的狀態標記, 例如 `showHelp bool`.
    -   修改 `view` 函數, 根據 `showHelp` 狀態決定是否渲染幫助視圖.
2.  **`internal/app/regex_help.go` (新建)**:
    -   定義 `HelpItem struct { Title, Pattern string }`.
    -   定義 `HelpContent struct { Common []HelpItem; Escapes []HelpItem }`.
    -   創建一個 `var RegexHelpData = HelpContent{...}` 的變量, 分別填充 "常用正則" 和 "基本正則轉義符" 的內容.
3.  **`internal/app/handlers.go`**:
    -   創建一個新的幫助視圖組件, 該組件負責渲染 `RegexHelpData`.
    -   視圖需要包含兩個帶標題的列表, 分別對應 `Common` 和 `Escapes`.
    -   實現選擇邏輯, 當用戶在幫助視圖中選擇任一項時, 發送一個消息 ( `tea.Msg` ), 將選中的 `Pattern` 傳遞回主模型.
4.  **`internal/app/app.go`**:
    -   在主 `model` 中處理來自幫助視圖的消息, 將接收到的 `Pattern` 更新到輸入框 `textinput.Model` 中.

### 歷史記錄配置文件

保存用戶輸入過的正則表達式歷史記錄, 方便重複使用, 提高效率.

功能設計:
-   **配置文件**:
    -   在用戶的主目錄下創建一個配置文件, 路徑為由參數指定, 或從環境變量讀取.
        - 參數優先級大於環境變量
        - 不存在默認值, 沒有指定保存位置就不進行存儲
    -   如果目錄或文件不存在, 應用程序在首次退出時自動創建.
-   **數據格式**:
    -   使用 JSON 格式.
    -   文件內容是一個 JSON 對象, 包含一個 `patterns` 鍵, 其值為一個數組, 存儲歷史記錄.
-   **歷史記錄管理**:
    -   應用程序啟動時, 從 `history.json` 文件加載歷史記錄.
    -   用戶在主界面按下 `上/下` 箭頭鍵時, 可以在輸入框中遍歷歷史記錄.
    -   在用戶執行導出或退出的時候, 將當前的正則表達式添加到歷史記錄的頂部.
    -   如果模式已存在, 則將其移動到頂部.
    -   歷史記錄將限制最大條數 (例如, 500條), 超出部分將被移除.
    -   應用程序正常退出時, 將內存中的歷史記錄寫回配置文件中.

數據格式:
```
{
    "patterns": [
        {
            "regex": "^foo.*",
            "firstMatch": "foo abcd",
            "ts": "保存時間的時間戳",
            "count": "使用次數"
        }
    ]
}
```

設計方案:

1.  **`main.go`**:
    -   使用 `flag` 包定義一個 `-history-file` 命令行標誌.
    -   檢查該標誌, 如果未提供, 則通過 `os.Getenv` 檢查 `REGEX_FIND_HISTORY_FILE` 環境變量.
    -   將獲取到的路徑 (如果存在) 傳遞給 `app.New()` 構造函數.
    -   在程序退出時, 從 App 獲取最終的歷史記錄, 並調用 `config.SaveHistory` 進行保存.
2.  **`internal/app/config.go` (新建)**:
    -   定義 `HistoryItem struct { Regex string json:"regex"; FirstMatch string json:"firstMatch"; Timestamp int64 json:"ts"; Count int json:"count" }`.
    -   定義 `History struct { Patterns []HistoryItem json:"patterns" }`.
    -   實現 `LoadHistory(path string) (History, error)`: 如果 `path` 為空, 返回空的 `History`. 否則, 從 `path` 加載.
    -   實現 `SaveHistory(path string, data History) error`: 如果 `path` 為空, 直接返回. 否則, 將 `data` 保存到 `path`.
3.  **`internal/app/app.go`**:
    -   在 `Model` 結構體中增加 `historyFilePath string` 和 `history []config.HistoryItem`.
    -   `New(historyPath string)` 函數在初始化時調用 `config.LoadHistory` 來填充 `model.history`.
    -   實現一個方法, 在執行搜索後被調用, 用於更新歷史記錄:
        -   接收 `regex` 字符串和第一個匹配結果 `firstMatch`.
        -   檢查 `regex` 是否已存在:
            -   如果存在, 增加其 `Count`, 更新 `Timestamp`, 並將其移動到列表頂部.
            -   如果不存在, 創建一個新的 `HistoryItem` 並添加到列表頂部.
        -   確保歷史記錄列表不超過 500 條.
4.  **`internal/app/ui.go`**:
    -   修改 `update` 函數對 `上/下` 箭頭鍵的處理, 從 `model.history` 列表中獲取 `HistoryItem`, 並使用其 `Regex` 字段填充輸入框.
    -   修改執行搜索的邏輯 (例如 `Enter` 鍵處理), 使其在搜索完成後觸發一個 `tea.Cmd`, 該命令負責調用 `app.go` 中更新歷史記錄的方法.

## 實現過程關鍵點

1.  **項目結構與文件職責**:
    *   `internal/app/config.go`: 新建文件, 專門用於處理歷史記錄的數據結構 `HistoryItem`, 以及與 JSON 格式的序列化和反序列化相關的邏輯 (`LoadHistory`, `SaveHistory`).
    *   `internal/app/regex_help.go`: 新建文件, 用於靜態存儲 `F2` 幫助頁面的內容 (常用正則和轉義符), 使幫助內容與應用邏輯解耦.
    *   `main.go`: 修改入口文件, 增加對 `--history-file` 命令行標誌和 `REGEX_FIND_HISTORY_FILE` 環境變量的解析, 以確定歷史文件路徑. 同時, 增加了程序退出時的鉤子 (hook), 以便保存最終的歷史記錄.
    *   `events.go`: 集中修改事件處理邏輯, 實現了 `F1`, `F2`, `Up`, `Down` 等新快捷鍵的響應.
    *   `ui.go`: 修改 UI 佈局, 恢復了原有的 `F1` 幫助彈窗, 並創建了新的 `F2` 幫助頁面.
    *   `handlers.go`: 在導出處理函數 `handleExport` 中增加了對歷史記錄更新的調用.

2.  **歷史記錄功能邏輯**:
    *   **觸發條件變更**: 根據需求, 將歷史記錄的更新時機從 "每次按 Enter 執行搜索時" 調整為 "成功導出時" 和 "程序退出前".
    *   **實現方式**:
        *   移除了 `events.go` 中 `Enter` 鍵對 `updateHistory` 的直接調用.
        *   在 `handlers.go` 的 `handleExport` 函數成功執行後調用 `updateHistory`.
        *   在 `main.go` 中, 於 `SaveHistory` 之前調用 `UpdateHistoryWithCurrentRegex`, 確保當前輸入框內的正則在退出時也被保存.
    *   **導航**: 使用 `Up`/`Down` 鍵遍歷歷史記錄的功能在 `events.go` 中為正則輸入框 `regexInput` 設置的 `InputCapture` 中實現.

3.  **幫助功能邏輯**:
    *   恢復了 `F1` 作為快捷鍵幫助彈窗 (keybindings) 的功能.
    *   新增了 `F2` 作為正則表達式參考幫助頁面的功能.
    *   為區分兩者, 在 `constants.go` 和 `ui.go` 中分別定義了 `KeybindingsHelpPage` 和 `RegexHelpPage`.
    *   通過在 `App` 結構中設置布爾標記 `showHelp` 來跟蹤 `F2` 幫助頁面的可見性, 以便在 `events.go` 中正確地管理事件捕獲的優先級.

4.  **錯誤修復與重構**:
    *   修復了 `events.go` 中因錯誤的頁面存在性檢查 (`HasPage`) 導致 `F1`/`F2` 全局快捷鍵被屏蔽的邏輯錯誤.
    *   修復了 `config.go` 中 `HistoryItem` 結構體字段名 (`First`) 與設計文檔 (`firstMatch`) 不一致的問題, 統一為 `FirstMatch`, 以解決編譯錯誤.
    *   **重大實現修正**: 在開發初期, 曾錯誤地嘗試用 `bubbletea` 框架重寫核心 `app.go`, 導致與項目現有的 `tview` 框架不兼容. 後續版本修正了此問題, 回退到在 `tview` 框架基礎上進行功能實現, 確保了技術棧的一致性.

## AI 成本

| Model Usage | Reqs | Input Tokens | Cache Reads | Output Tokens |
| --- | --- | --- | --- | --- |
| gemini-2.5-flash-lite | 11 | 36,490 | 0 | 1,846 |
| gemini-2.5-pro | 78 | 644,504 | 2,978,072 | 35,660 |
| gemini-2.5-flash | 3 | 11,417 | 0 | 1,370 |
