---
version: "0.0.1"
---

# 2025-12-08

## 目標

- [x] 一個最簡單的可運行的工具

## 需求

1. 實現一個有兩個輸入框的界面
    1. 第一個窗口負責輸入正則
    2. 第二個窗口負責輸入待匹配的文本
2. 使用 tab 鍵進行兩個窗口的輸入切換
3. 高亮匹配到的文本
4. 使用 tview 庫實現 tui 交互邏輯
5. 使用 `Ctrl+C` 或 `Ctrl+D` 來結束交互程序

## 限制

在 internal 文件實現所有具體的業務邏輯

## 實現過程關鍵點

1. **混合窗口的實現**: 核心需求是將"文本輸入"和"高亮顯示"合併到同一個窗口.
    - **方案**: 使用 `tview.TextView` 作為顯示組件, 並通過 `app.SetInputCapture` 攔截鍵盤事件來模擬輸入.
    - **細節**:
        - 獨立的 `strings.Builder` 用於存儲原始的、未經高亮處理的文本.
        - 當 `TextView` 獲得焦點時, `InputCapture` 會捕獲按鍵 (`KeyRune`, `KeyBackspace`), 更新 `strings.Builder` 中的內容.
        - 每次內容更新後, 調用 `updateHighlight` 函數, 該函數會根據正則表達式重新計算高亮, 並調用 `TextView.SetText()` 更新顯示內容.

2. **事件處理與UI凍結問題**: 初版實現中, 在事件處理函數內直接調用 `app.Draw()` 或 `app.QueueUpdateDraw()`, 導致UI線程與事件線程衝突, 引發程序凍結, 無法輸入.
    - **解決方案**: 移除事件處理器中所有的 `Draw()` 和 `QueueUpdateDraw()` 調用. `tview` 的主循環會在 `SetText()` 被調用後自動處理重繪.

3. **全局輸入捕獲 (`InputCapture`)**:
    - **統一管理**: 最終採用單一的、全局的 `app.SetInputCapture` 來處理所有特殊按鍵, 包括退出 (`Ctrl+C`/`Ctrl+D`)和焦點切換 (`Tab`).
    - **事件傳遞**: 最關鍵的修復是, 在 `InputCapture` 中, 對於不需要特殊處理的按鍵 (例如在 `InputField` 中輸入的字符), 必須原樣 `return event`. 如果 `return nil`, 事件將被消費, 無法傳遞給當前聚焦的組件 (如 `InputField`), 導致其無法接收輸入.

