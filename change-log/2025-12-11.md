---
version: "0.0.4"
---

# 2025-12-11

## 目標

- [x] 最終確認並實現文本展示與編輯方案

## 詳細需求

### 方案評估與決策

根據前一天的討論, 對現有的"合併式編輯/顯示框"方案的優缺點進行復盤.
在閱讀代碼之後發現, 實現上還是很麻煩的, 並且在之後主動加載文件還需要處理相應內存狀態.

在測試中發現粘貼和非英文字符也出現了問題, 之後要解決這個問題會更麻煩, 加上不同輸入法的輸入會產生更多不可控的問題, 自己維護成本太高了.

昨天調研了下 tview 插件, 看這個需求好像並不好實現, 原生沒有提供相應的 API 直接是使用.

對我個人來說, 關注的點實際上匹配結果和匹配遺漏, 匹配的展示要可能清晰, 並方便檢驗我匹配到的內容和期望是否一致.

最終的方案是繼續使用舊的方案, 使用 `tview.TextArea` 進行輸入 `tview.TextView` 進行高亮顯示.

### 高亮展示和編輯

- 將界面拆分成四部分, 分別是正則輸入, 文本輸入, 高亮展示, 匹配結果
- 其中正則輸入和文本輸入依舊保持原有方案.
- 四個輸入框的選定可以使用 Tab 切換來實現不同的控制.
- 高亮展示部分不需要支持輸入了, 保持之前高亮的規則. 但因爲空間減小所以需要支持內容滾動, 上下翻頁的功能, 翻頁使用方向鍵和 vim 的方向鍵 `hjkl`
- 匹配結果直接使用行展示匹配的內容, 超過一定長度後將中間部分省略掉.
    - 如果匹配的內容有換行或製表符等字符, 統一使用"轉義字符"的方式展示.

基本排版樣式:
```
|     Regular Expression    |
| ------------------------- |
|      Text Input           |
| ------------------------- |
|  Highlighted  |  Match    |
```

匹配展示樣式:

```
0: xxx .... end
1: yyy .... end
2: ....
```

## 限制

- 在 internal 文件實現所有具體的業務邏輯

## 實現過程關鍵點

1.  **方案回退與代碼重構**: 根據最終決策，放棄了前一天實現的、將編輯與顯示功能合併到單一 `TextView` 的複雜方案。轉而回退到更穩定、職責分離的設計，即使用 `tview.TextArea` 負責文本輸入，`tview.TextView` 負責高亮顯示。不再需要的 `internal/editor` 包被歸檔到 `backup` 目錄。

2.  **四窗格佈局實現**:
    *   使用嵌套的 `tview.Flex` 重新構建了 UI，實現了 `正則輸入 | 文本輸入 | (高亮顯示 | 匹配結果)` 的四窗格佈局。
    *   主 Flex 容器為縱向佈局，包含頂部的 `regexInput`、`textArea` 和底部的 `bottomPane`。
    *   `bottomPane` 本身是一個橫向 Flex 容器，用於並排容納 `highlightedView` 和 `matchView`。

3.  **獨立匹配視圖 (`matchView`)**:
    *   新增了一個 `tview.TextView` 作為 `matchView`，專門用於清晰地、按行展示所有正則匹配的結果。
    *   為此創建了 `updateMatchView` 函數，該函數負責格式化每條匹配記錄。
    *   格式化邏輯包括：為每條結果添加行號索引、對包含換行或製表符的特殊字符進行轉義 (`strconv.Quote`)，以及對過長的匹配內容進行截斷，確保每條記錄都能在單行內清晰展示。

4.  **統一的事件處理與焦點管理**:
    *   重構了 `cycleFocus` 函數，使其能夠在全部四個交互式窗格（`regexInput`, `textArea`, `highlightedView`, `matchView`）之間循環切換焦點。
    *   實現了一個通用的 `handleScrolling` 函數，為當前擁有焦點的 `TextView`（`highlightedView` 或 `matchView`）提供 `hjkl` 和方向鍵滾動支持，增強了代碼的複用性。
    *   通過為 `regexInput` 和 `textArea` 設置 `SetChangedFunc` 回調，簡化了 UI 更新流程，任何輸入變化都會自動觸發統一的 `updateHighlight` 函數，從而同時刷新高亮視圖和匹配列表。

## AI 成本

| Model Usage | Reqs | Input Tokens | Output Tokens |
| --- | --- | --- | --- |
| gemini-2.5-flash-lite | 4 | 27,363 | 541 |
| gemini-2.5-pro | 10 | 164,576 | 6,828 |
