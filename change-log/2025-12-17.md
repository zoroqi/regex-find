---
version: 0.0.8
---

# 2025-12-17

## 目標

- [x] 減少代碼中的硬編碼(Hard coding)情況
- [x] `Highlighted` 和 `Matches` 對話框支持更多跳轉操作

## 需求

### 各種名稱值修改成常量

為了提高代碼的可讀性和可維護性, 避免在代碼中散落各種"魔術字符串", 我們需要將 UI 相關的標題, 名稱和標籤等硬編碼值提取為常量.

**設計:**

1.  在 `internal/app/` 目錄下創建一個新的 `constants.go` 文件.
2.  將以下類型的字符串和數值定義為常量:
    -   **頁面名稱 (Page Names)**: 用於 `tview.Pages` 切換的鍵名, 例如 `"main"`, `"help"`, `"export"`, `"result"`.
    -   **UI 組件標題 (Widget Titles)**: 各視圖和表單的標題, 例如 `"Regex"`, `"Text"`, `"Highlighted"`, `"Matches"`, `"Help"`, `"Export Options"`.
    -   **表單元素標籤 (Form Labels)**: 導出表單中的字段標籤, 例如 `"Export Format"`, `"Output Target"`, `"File Path"`.
    -   **導出選項 (Export Options)**: 導出格式的下拉菜單選項, 例如 `"JSON (All)"`, `"JSON (Groups)"`, `"Custom format"`.
    -   **提示信息 (Hint Messages)**: 幫助欄中的提示文本.
3.  在 `ui.go` 和 `app.go` 中, 將所有硬編碼的字符串替換為新定義的常量.
    -   例如, `tview.NewTextView().SetTitle("Matches")` 應改為 `tview.NewTextView().SetTitle(TitleMatches)`.
    -   `app.pages.SwitchToPage("help")` 應改為 `app.pages.SwitchToPage(PageHelp)`.

### 對話框支持更多跳轉操作

為了方便用戶在 `Highlighted` 和 `Matches` 視圖中快速導航, 特別是當文本內容很長時, 我們需要增加更多的滾動和跳轉快捷鍵.

**設計:**

1.  為 `highlightedView` 和 `matchView` 這兩個 `tview.TextView` 組件增加以下鍵盤快捷鍵:
    -   `g` 或 `Home`: 跳轉到文本開頭.
    -   `G` 或 `End`: 跳轉到文本結尾.
    -   `Ctrl+F` 或 `PageDown`: 向下滾動一頁.
    -   `Ctrl+B` 或 `PageUp`: 向上滾動一頁.
    -   `n`: 跳轉到下一個匹配項 (Next match).
    -   `N`: 跳轉到上一個匹配項 (Previous match).
2.  在 `internal/app/events.go` 的 `setGlobalHandlers` 或類似的事件處理函數中, 針對 `highlightedView` 和 `matchView` 捕獲上述按鍵事件.
3.  當事件觸發時, 調用 `tview.TextView` 對應的滾動方法, 如 `ScrollToBeginning()`, `ScrollToEnd()`, 和 `ScrollTo(row, column)` 來實現頁面滾動. 對於 `n` 和 `N` 的跳轉, 需要額外邏輯來計算下一個/上一個匹配項在 `TextView` 中的行數, 然後使用 `ScrollTo` 方法.

## 實現過程關鍵點

1.  **常量化(Hard coding)**:
    -   創建了 `internal/app/constants.go` 文件, 集中管理所有 UI 相關的字符串, 包括頁面名稱, 組件標題, 表單標籤和按鈕文本.
    -   全面重構了 `ui.go` 和 `handlers.go` 文件, 將所有硬編碼的字符串替換為新定義的常量, 顯著提高了代碼的可維護性.
    -   修復了 `handleExport` 函數中遺漏的硬編碼問題, 確保了表單項的讀取也使用常量.

2.  **增強導航功能**:
    -   **擴展 App 狀態**: 在 `app.go` 的 `App` 結構體中增加了 `matchIndices`, `highlightedMatchLines`, `matchViewLines`, 和 `currentMatchIndex` 四個新字段, 用於存儲匹配項的索引, 在兩個視圖中的行號, 以及當前選中的匹配項.
    -   **實現行號計算**:
        -   在 `handlers.go` 中, 修改了 `updateHighlight` 相關的函數 (`updateHighlightedView`, `updateMatchView`).
        -   `updateHighlightedView` 現在會根據匹配項在原文中的字節偏移量計算其在 `TextView` 中的起始行號.
        -   `updateMatchView` 在生成匹配列表時會同步計算每個匹配塊的起始行號.
        -   這些數據會在每次正則匹配更新時被重新計算並存儲.
    -   **重構事件處理**:
        -   在 `events.go` 中, 創建了一個新的 `handleViewNavigation` 函數, 作為 `highlightedView` 和 `matchView` 的專用輸入捕獲器, 統一處理這兩個視圖的所有導航邏輯.
        -   實現了 `g`/`G`/`Home`/`End` (跳轉到頭/尾), `PageUp/Down` 和 `Ctrl+F/B` (翻頁) 以及標準滾動 (`hjkl`, 方向鍵) 的功能.
        -   新增了 `navigateToMatch(direction int)` 輔助函數, 封裝了 `n` (下一個) 和 `N` (上一個) 在匹配項之間跳轉的邏輯. 此函數利用預先計算好的行號數據, 通過 `ScrollTo` 實現精準跳轉.
