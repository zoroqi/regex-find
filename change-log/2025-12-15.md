---
version: "0.0.6"
---

# 2025-12-15

## 目標

- [x] 修改統計信息展示位置
- [x] 支持從剪貼板中讀取匹配內容
- [x] 將正則表達式輸出
- [x] 將匹配結果導出

## 需求

### 統計信息展示

當前匹配數量的展示在整個窗口的右下角, 在大屏幕不容易看到, 需要進行調整.

需求:
- 將統計數字從右下角移動到 "Matches" 窗口的標題部分
- 展示效果 `Matches(20)`

### 支持從剪貼板讀取

當前只支持從管道中和文件中讀取文本內容進行匹配, 需要進行修改支持更多的方式讀取文本內容

需求:
- 添加一個參數, 從剪貼板讀取文件
- 文本讀取優先級: `pipe > clipboard/file`
    - 當用戶同時指定剪貼板和文件的時候提示報錯

這裏剪貼板的讀寫操作使用 `golang.design/x/clipboard` 庫來完成, 這個庫我已經完成安裝可以直接使用.

### 輸出正則表達式

問題: 當前在完成所有內容後, 上並沒有提供任何有價值的數據輸出.

需求:
- 在程序退出的時候, 將當前"Regular Expression"輸入框中的正則表達式輸出
- 輸出位置直接使用標準輸出就可以

### 將匹配結果導出

問題: 匹配到的內容無法保存, 還需要其它工具來進行再提取或進行二次處理才能獲取相應的數據

需求:
- 在按下特定快捷鍵後彈出對話框進行數據保存
- 對話框需要用戶選擇保存格式
    1. json 保存全部內容
    2. json 保存特定分組
        - 用戶輸入特定分組號
        - 可以輸入多個分組編號, 每個編號使用逗號進行分割
    3. 自定義格式
        - 用戶輸入 `$1 $2` 方式的文本信息
        - `$\d` 轉換成分組編號
        - 保留用戶輸入格式
        - 兩個匹配結果之間使用 `\n` 分割
- 在選擇保存格式後, 選擇保存方式
    1. 保存到剪貼板
    2. 保存到文件
        - 需要用戶輸入文件地址

json 結構:

全部內容結構:
```json
{
    "regex": "regex",
    "maches": [
        {
            "0":"xxx",
            "1":"xxx",
            "2":"xxx"
        },
        {
            "0":"zzzz",
            "1":"xxx",
            "2":"xxx"
        }
    ]
}
```

特定分組:
```json
{
    "regex": "regex",
    "maches": [
        {
            "1":"xxx",
            "3":"xxx"
        },
        {
            "1":"xxx",
            "3":"xxx"
        }
    ]
}
```

自定義格式:

- 格式: `$1 \t $3 : $5`
- 保存結果: `xxx \t yyy : zzz` (其中 `\t` 需要轉換成製表符進行輸出)

## 實現過程關鍵點

### 1. 統計信息展示位置修改

- 在 `internal/app/app.go` 中, 修改了 `updateMatchView` 函數.
- 將原先更新 `statsView` 的代碼 `a.statsView.SetText(...)` 移除.
- 修改為更新 `matchView` 的標題: `a.matchView.SetTitle(fmt.Sprintf("Matches(%d)", len(matches)))
`.
- 在 `updateHighlight` 中清理了對 `statsView` 的無效更新.
- 從 `setupUI` 的 `statusBar` 中徹底移除了 `statsView` 組件, 簡化了佈局.

### 2. 從剪貼板讀取內容

- 在 `main.go` 中添加了新的命令行標誌 `-clipboard` (類型為 `bool`).
- 修改了 `main` 函數的文本加載邏輯, 實現了 `pipe > clipboard > file` 的優先級順序.
- 添加了對 `-clipboard` 和 `-file` 標誌不能同時使用的互斥校驗.
- 集成了 `golang.design/x/clipboard` 庫, 使用 `clipboard.Read(clipboard.FmtText)` 來讀取剪貼板中的文本內容.

### 3. 輸出正則表達式

- 在 `internal/app/app.go` 的 `App` 結構體中添加了 `GetRegexInput() string` 方法, 用於從外部獲取 `regexInput` 的當前值.
- 修改 `main.go`, 在 `app.Run()` 執行結束後, 調用 `appInstance.GetRegexInput()` 獲取正則表達式, 並使用 `fmt.Println()` 將其輸出到標準輸出.

### 4. 導出匹配結果

- **重構設計**: 根據用戶反饋, 放棄了複雜且容易出錯的動態表單項顯示/隱藏邏輯, 採用了更穩健的方案:
    1.  **UI 與邏輯分離**: 創建了 `createExportForm` 專門負責 UI, `handleExport` 專門負責處理邏輯.
    2.  **簡化 UI**: 導出表單一次性展示所有輸入字段, 不再動態增刪, 避免了 `tview` API 的複雜操作.
    3.  **分層頁面**: 引入了 `modalPages (*tview.Pages)` 作為頂層容器, 用於實現結果提示框 (Modal) 的疊加顯示, 提升了用戶反饋體驗.
- **快捷鍵與佈局**:
    - 在 `setupEventHandlers` 中添加了 `Ctrl+E` 作為導出快捷鍵.
    - 在 `setupUI` 中使用 `tview.Flex` 佈局來將導出表單居中顯示.
- **輸入焦點處理**: 解決了導出表單無法交互的問題.
    - 為 `Ctrl+E` 事件添加 `a.app.SetFocus(a.exportForm)`, 確保表單顯示時自動獲得焦點.
    - 在全局 `InputCapture` 中添加了判斷, 當 `exportForm` 擁有焦點時, 不攔截關鍵盤事件 (如 `Tab`), 讓表單可以正確處理內部導航.
- **核心導出邏輯**:
    - 在 `handleExport` 中實現了從表單獲取用戶選擇和輸入的邏輯.
    - 創建了 `generateExportJSONAll`, `generateExportJSONGroups`, `generateExportCustom` 三個輔助函數, 分別處理不同格式的數據生成.
    - 創建了 `saveToClipboard` 和 `saveToFile` 兩個輔助函數, 處理數據的最終保存.
    - 整個流程包含完整的錯誤處理, 並通過 `showResultModal` 給予用戶清晰的操作結果反饋.
- **問題修復**: 多次修復了由於 `write_file` 操作不當導致的語法錯誤, 最終通过 `replace` 和 `write_file` 结合的方式完成了代码的正确修改.

## AI 成本

| Model Usage | Reqs | Input Tokens | Output Tokens |
| --- | --- | --- | --- |
| gemini-2.5-flash-lite | 13 | 70,089 | 25,848 |
| gemini-2.5-flash | 53 | 795,856 | 10,991 |
| gemini-2.5-pro | 55 | 5,062,155 | 43,471 |
