---
version: "0.0.11"
---

# 2025-12-20

## 目標

- [x] 代碼結構調整

## 需求

### 代碼結構調整

根據項目當前的代碼狀況，我們制定了以下重構方案，旨在解決 `internal/app` 包職責過重（God Struct）的問題，遵循 "僅保留一個 internal 層級" 和 "合理拆分文件" 的原則。

#### 1. 重構目標

1.  **職責分離 (Separation of Concerns)**: 將 "純業務邏輯" (正則匹配、字符串格式化) 與 "UI 邏輯" (組件更新、顏色標籤生成) 分離。
2.  **可測試性 (Testability)**: 業務邏輯應當是無狀態的純函數，不依賴 `App` 實例或 `tview` 組件，便於編寫單元測試。
3.  **代碼清晰度 (Clarity)**: 通過更細粒度的文件劃分，讓每個文件的職責單一且清晰。

#### 2. 文件結構優化方案

保持 `internal/app` 包不變，對其中的文件進行重組和拆分：

| 文件名 | 當前狀態 | 優化後職責 | 變更說明 |
| :--- | :--- | :--- | :--- |
| `app.go` | God Struct | **控制器 (Controller)** | 僅保留 `App` 結構體定義、初始化 (`New`)、啟動 (`Run`) 和狀態管理。 |
| `config.go` | 獨立 | **配置管理** | 保持不變 (歷史記錄加載/保存)。 |
| `constants.go` | 獨立 | **常量定義** | 保持不變。 |
| `events.go` | 混合 | **事件路由** | 專注於全局鍵盤事件的監聽與分發，調用 `handlers`。 |
| `handlers.go` | 混合 | **交互處理** | 處理具體的用戶動作 (如 "點擊導出按鈕", "確認搜索")。調用 Logic 獲取數據，再調用 UI Update 更新視圖。 |
| `logic_export.go` | **(新增)** | **導出邏輯 (Pure Logic)** | 存放 `GenerateExportJSON`、`GenerateExportCustom` 等純函數。**不依賴 App**。 |
| `logic_regex.go` | **(新增)** | **匹配邏輯 (Pure Logic)** | 存放 `PerformSearch` 等函數，負責正則編譯和數據提取。**不依賴 App**。 |
| `ui.go` | 混合 | **UI 構建 (View)** | 專注於 `setupUI` 和各個 View 的初始化 (`createForm`, `createModal`)。 |
| `ui_update.go` | **(新增)** | **UI 更新 (View Logic)** | 存放 `updateHighlight`, `updateMatchView` 等函數。負責將數據轉換為帶顏色標籤的 TUI 字符串。 |
| `history_view.go` | 獨立 | **組件 (Component)** | 保持不變 (歷史記錄視圖組件)。 |
| `regex_help.go` | 獨立 | **數據 (Data)** | 保持不變 (幫助文檔數據)。 |
| `app_test.go` | 測試 | **單元測試** | 更新測試以針對新的 `logic_*.go` 中的純函數進行測試。 |

#### 3. 詳細重構步驟

**第一步：提取導出邏輯 (Refactor Export Logic)**
將 `handlers.go` 中依賴 `App` 狀態的導出生成方法，改為接收數據的純函數，並移動到新文件。
*   **創建** `internal/app/logic_export.go`
*   **提取**:
    *   `generateExportJSONAll` -> `GenerateExportJSONAll(regex string, matches [][]string) ([]byte, error)`
    *   `generateExportJSONGroups` -> `GenerateExportJSONGroups(regex string, matches [][]string, groupInput string) ([]byte, error)`
    *   `generateExportCustom` -> `GenerateExportCustom(matches [][]string, format string) (string, error)`
*   **修改**: `app_test.go` 直接測試這些新函數。

**第二步：提取 UI 更新邏輯 (Refactor UI Update Logic)**
將 `app.go` 中負責拼接帶顏色字符串的邏輯分離。
*   **創建** `internal/app/ui_update.go`
*   **移動**:
    *   `updateHighlightedView(text string, matches [][]int)`
    *   `updateMatchView(matches [][]string)`
*   **優化**: 這些方法仍然可以是 `App` 的方法 (因為它們操作 UI 組件)，但將它們移出 `app.go` 可以給主文件瘦身。

**第三步：提取正則匹配邏輯 (Refactor Regex Logic)**
將正則編譯和搜索邏輯分離。
*   **創建** `internal/app/logic_regex.go`
*   **提取**:
    *   創建 `Search(regexStr, text string) (*regexp.Regexp, [][]int, [][]string, error)` 函數。
*   **修改**: `App.updateHighlight` 調用此函數獲取數據，然後調用 `ui_update.go` 中的方法更新視圖。

**第四步：清理與整合**

*   `handlers.go` 將只包含處理用戶輸入並協調 Logic 與 UI 的代碼。

*   `app.go` 將變得非常簡潔，只包含結構體定義和生命週期管理。

**第五步：歷史記錄邏輯重構 (History Logic Refactoring)**

將 `updateHistory` 邏輯從 `App` 移動到 `HistoryView`。

*   **封裝**: `HistoryView` 負責歷史數據的添加、去重、排序和截斷。

*   **瘦身**: `App` 不再直接管理 `history` 切片，而是將操作委託給 `HistoryView`。

## AI 成本

| Model Usage | Reqs | Input Tokens | Cache Reads | Output Tokens |
| --- | --- | --- | --- | --- |
| gemini-2.5-flash-lite | 7 | 59,485 | 0 | 5,077 |
| gemini-3-pro-preview | 32 | 235,295 | 1,116,534 | 18,993 |
| gemini-2.5-flash | 1 | 4,959 | 0 | 2,023 |

