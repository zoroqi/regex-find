# regex-find 設計文檔

本文檔描述了 `regex-find` 工具的當前設計與實現, 這是一個基於終端的交互式正則表達式測試工具.

## 1. 總覽 (Overview)

`regex-find` 是一個使用 Go 語言和 `tview` 庫開發的 TUI (文本用戶界面) 應用. 它提供了一個實時反饋的環境, 用戶可以輸入正則表達式和待匹配的文本, 應用程序會立即高亮所有匹配項, 並在一個專門的視圖中詳細列出所有匹配結果及其捕獲組.

## 2. 核心功能 (Core Features)

- **實時正則匹配**: 在用戶輸入正則表達式或文本時, 實時更新匹配結果.
- **多源文本輸入**: 支持從命令行管道 (`pipe`), 文件 (`-file` 標誌), 系統剪貼板 (`-clipboard` 標誌) 或手動輸入來加載待匹配的文本. 文本加載的優先級為: `pipe > clipboard/file`.
- **四窗格佈局**:清晰地將正則輸入, 文本輸入, 高亮結果和匹配列表分離, 提供直觀的操作體驗.
- **高亮顯示**: 使用交替的背景色 (綠色/藍色) 在原文中清晰地標記出所有匹配的文本段.
- **詳細的匹配列表與統計**:
    - 在 "Matches" 視圖的標題欄中實時顯示匹配總數, 格式為 `Matches(20)`.
    - 逐行展示每一個匹配結果.
    - 縮進展示每個匹配結果下的所有捕獲組 (capture groups).
    - 對特殊字符 (如換行, 製表符) 進行轉義, 確保單行顯示的清晰性.
- **結果導出**:
    - 按下 `Ctrl+E` 快捷鍵可彈出導出對話框.
    - 支持多種導出格式: JSON (全部內容), JSON (指定分組), 以及自定義格式.
    - **自定義格式 (`Custom format`) 支持轉義字符**: 在格式化字符串中, `\n`, `\t` 等轉義序列會被正確地解析為換行和製表符.
    - 支持導出到系統剪貼板或指定文件.
    - 提供操作結果反饋 (成功或失敗) 的提示框.
- **程序退出時輸出**: 應用程序正常退出時, 會將最後使用的正則表達式輸出到標準輸出.
- **滾動查看**: "高亮視圖" 和 "匹配列表" 均支持使用方向鍵及 Vim 風格的 `hjkl` 鍵進行內容滾動.
- **幫助系統 (Help System)**:
    - **按鍵綁定幫助 (`F1`)**: 提供一個彈出式窗口, 快速查看應用程序的核心操作快捷鍵.
    - **正則表達式幫助 (`F2`)**: 提供一個全屏參考頁面, 列出了常用正則表達式模式 (如 Email, URL) 和基本轉義字符 (如 `\d`, `\w`), 方便用戶查找和學習.
- **歷史記錄視窗 (`F3`)**:
    - 按下 `F3` 鍵可彈出一個獨立的歷史記錄視窗.
    - 該視窗以表格形式展示了所有歷史記錄, 並包含一個過濾框, 用戶可實時搜索正則或匹配內容.
    - 用戶可從表格中選擇一項, 選中的正則表達式將被自動填充回主輸入框.
    - **持久化存儲**: 應用程序會自動保存使用過的正則表達式. 記錄的更新發生在執行導出操作或正常退出程序時.
    - **可配置路徑**: 歷史記錄文件的存儲位置可以通過 `--history-file` 命令行標誌或 `REGEX_FIND_HISTORY_FILE` 環境變量进行自定義.
- **焦點切換**: 使用 `Tab` 和 `Shift+Tab` 可以在四個可交互的窗格之間循環切換焦點.

## 3. UI 佈局與組件

應用界面基於 `tview` 的 `Flex` 和 `Pages` 組件構建. 為了支持模態對話框 (Modal) 的正確疊加顯示, 整個 UI 結構採用了分層的 `tview.Pages`:

1.  **`modalPages`**: 作為應用程序的頂層根容器. 它始終顯示一個基礎頁面 (`pages`), 並負責在其上動態地 **添加 (AddPage)** 和 **移除 (RemovePage)** 所有模態視窗, 如幫助 (`F1`, `F2`), 歷史記錄 (`F3`), 導出 (`Ctrl+E`) 和結果提示框.
2.  **`pages`**: 現在僅作為 `modalPages` 的基礎層, 包含且僅顯示應用的主界面 (`MainPage`). 它不再負責模態視窗之間的切換.

這種分層設計確保了模態視窗可以正確地疊加在主界面之上, 而不是替換它.

主界面佈局 (`a.flex`) 如下:
```
+--------------------------------------------------+
|  regexInput (*tview.InputField)                  |
+--------------------------------------------------+
|  textArea (*tview.TextArea)                      |
+--------------------------------------------------+
|  +-------------------+-------------------------+ |
|  | highlightedView   | matchView               | |
|  | (*tview.TextView) | (*tview.TextView)       | |
|  +-------------------+-------------------------+ |
|  +---------------------------------------------+ |
|  | helpHintView (*tview.TextView)              | |
|  +---------------------------------------------+ |
+--------------------------------------------------+
```

- **導出界面**: `export page` 包含一個 `tview.Form`, 用於收集用戶的導出選項. 該頁面通過 `Flex` 佈局實現居中顯示.
- **結果提示框**: 導出操作完成後, 會在 `modalPages` 上彈出一個臨時的 `result` 頁面, 顯示操作成功或失敗的信息.

## 4. 檔案結構 (File Structure)

為了提升代碼的可讀性和可維護性, 項目遵循關注點分離的原則對文件進行了組織.

- **`main.go`**:
  - 程序的唯一入口.
  - 負責解析命令行參數 (`-file`, `-clipboard`).
  - 根據參數從不同的輸入源 (stdin, file, clipboard) 讀取初始文本.
  - 初始化並運行 `internal/app` 中的 TUI 應用.

- **`internal/app/`**:
  - 存放所有 TUI 相關的核心代碼, 構成一個獨立的 `app` 包.
  - **`app.go`**:
    - 定義核心的 `App` 結構體, 包含所有 UI 組件和應用狀態.
    - 提供 `New()` 構造函數和 `Run()` 啟動函數.
  - **`ui.go`**:
    - 負責所有 UI 組件的初始化, 佈局和外觀配置.
    - 包含 `setupUI()`, `createHelpModal()`, `createExportForm()` 等函數.
  - **`events.go`**:
    - 負責設置和管理所有的鍵盤輸入和事件捕獲.
    - 包含 `setupEventHandlers()`, `cycleFocus()`, `handleScrolling()` 等函數.
  - **`handlers.go`**:
    - 包含響應事件後執行的核心業務邏輯.
    - 例如 `updateHighlight()` (執行正則匹配並更新視圖), `handleExport()` (處理導出邏輯) 等.
  - **`history_view.go`**:
    - 實現了 `F3` 歷史記錄視窗的複合組件.
    - 包含 `tview.Table` 和 `tview.InputField`, 並負責過濾, 導航和選擇邏輯.
  - **`app_test.go`**:
    - 提供了針對 `app` 包內業務邏輯的單元測試, 特別是針對導出功能的各種場景.
